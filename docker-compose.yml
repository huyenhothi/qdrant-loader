services:
  qdrant:
    container_name: qdrant
    image: qdrant/qdrant:latest
    restart: unless-stopped
    ports:
      - "6333:6333"
      - "6334:6334"
    configs:
      - source: qdrant_config
        target: /qdrant/config/production.yaml
    volumes:
      - qdrant_data:/qdrant/storage
    environment:
      - QDRANT__LOG_LEVEL=INFO
      - QDRANT__SERVICE__HTTP_PORT=6333
      - QDRANT__SERVICE__GRPC_PORT=6334
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:6333/healthz"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    networks:
      - qdrant-net
  
  qdrant-loader:
    container_name: qdrant-loader
    build:
      context: ../qdrant-loader
      dockerfile: Dockerfile.qdrant-loader
    restart: "no"
    depends_on: 
      - qdrant
    env_file:
      - .env
    environment:
      - QDRANT_URL=http://qdrant:6333
      - ENABLE_PROFILING=true
    volumes:
      # ðŸ”´ QUAN TRá»ŒNG: bind mount config tá»« HOST
      - ../qdrant-loader/workspace:/qdrant-loader/workspace
      # - ../qdrant-loader/config.yaml:/config.yaml
      - ../qdrant-loader/set-docs:/qdrant-loader/set-docs
    command: ["sleep", "infinity"]
    networks:
      - qdrant-net

  # minio:
  #   image: minio/minio:latest
  #   container_name: minio
  #   restart: unless-stopped
  #   environment:
  #     MINIO_ROOT_USER: ${MINIO_ROOT_USER}
  #     MINIO_ROOT_PASSWORD: ${MINIO_ROOT_PASSWORD}
  #   command: server /data --console-address ":9001"
  #   ports:
  #     - "9000:9000"
  #     - "9001:9001"
  #   volumes:
  #     - ./minio_data:/data
  #   healthcheck:
  #     test: ["CMD", "curl", "-f", "http://localhost:9001"]
  #     interval: 30s
  #     timeout: 10s
  #     retries: 3
  #     start_period: 10s
  #   networks:
  #     - minio-net

volumes:
  qdrant_data:
    driver: local

networks:
  qdrant-net:
    driver: bridge
  # minio-net:
  #   driver: bridge

configs:
  qdrant_config:
    content: |
      log_level: INFO